<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>MFA Salah Clock</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      --bg: #050608;
      --fg-soft: #cbd5f5;
      --fg-strong: #fef2c0;
      --fg-before: #76c7ff;
      --fg-danger: #ff6b6b;
      --fg-over: #888ea8;
      --pill-active: #4f46e5;
      --pill-upcoming: #1f2937;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      background: radial-gradient(circle at top, #101320, #020308 55%);
      color: var(--fg-soft);
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
        "Segoe UI", sans-serif;
      height: 100vh;
      width: 100vw;
      display: flex;
      align-items: stretch;
      justify-content: stretch;
    }

    .wrapper {
      width: 100%;
      height: 100%;
      border-radius: 0;
      padding: 24px 32px 24px;
      background: rgba(9, 11, 25, 0.96);
      display: flex;
      flex-direction: column;
      gap: 24px;
      transition: background 0.2s ease;
    }

    /* Fajr mode backgrounds */
    .wrapper.fajr-mode {
      background: radial-gradient(circle at top, #3b1020, #050308 60%);
    }

    .wrapper.fajr-warning {
      background: radial-gradient(circle at top, #7f1d1d, #120308 60%);
    }

    .header-bismillah {
      text-align: center;
      font-size: 1.7rem;
      color: #e5e7eb;
      margin-bottom: -4px;
      letter-spacing: 0.05em;
    }

    .clock-container {
      text-align: center;
    }

    /* main time ≈ 1.2" on Fire tablet */
    .time {
      font-size: clamp(6.5rem, 20vw, 11rem);
      font-weight: 600;
      letter-spacing: 0.14em;
      color: #f9fafb;
      text-shadow: 0 0 36px rgba(148, 163, 253, 0.7);
      margin-bottom: 8px;
    }

    .date {
      font-size: 1.4rem;
      color: #bcc2d6;
      letter-spacing: 0.2em;
      text-transform: uppercase;
    }

    .status-block {
      padding: 24px 26px 24px;
      border-radius: 26px;
      background: linear-gradient(
        135deg,
        rgba(15, 23, 42, 0.98),
        rgba(17, 24, 39, 0.98)
      );
      border: 1px solid rgba(148, 163, 253, 0.2);
    }

    .status-label {
      font-size: 1.1rem;
      text-transform: uppercase;
      letter-spacing: 0.24em;
      color: #8288a0;
      margin-bottom: 14px;
      text-align: center;
    }

    .status-main {
      font-size: 2.1rem;
      font-weight: 600;
      margin-bottom: 10px;
      text-align: center;
    }

    .status-main.before {
      color: var(--fg-before);
    }

    .status-main.active {
      color: var(--fg-strong);
    }

    .status-main.danger {
      color: var(--fg-danger);
    }

    .status-main.over {
      color: var(--fg-over);
    }

    /* Fajr emphasis */
    .status-main.fajr-large {
      font-size: clamp(4.5rem, 13vw, 8.5rem);
    }

    .status-detail {
      font-size: 1.6rem;
      color: #d1d3e0;
      text-align: center;
      line-height: 1.5;
    }

    .status-detail.danger {
      color: var(--fg-danger);
      font-weight: 600;
    }

    .status-detail.fajr-large {
      font-size: clamp(2.6rem, 9vw, 5rem);
    }

    .small-note {
      font-size: 1rem;
      color: #81869a;
      margin-top: 14px;
      text-align: center;
      line-height: 1.4;
    }

    .prayer-row {
      display: flex;
      justify-content: space-between;
      gap: 12px;
      margin-top: 4px;
      padding-top: 16px;
      border-top: 1px solid rgba(31, 41, 55, 0.9);
    }

    .prayer-pill {
      flex: 1;
      border-radius: 999px;
      padding: 14px 10px 16px;
      background: rgba(15, 23, 42, 0.9);
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
      transition: all 0.2s ease;
    }

    .prayer-pill .prayer-name {
      font-size: 1.05rem;
      letter-spacing: 0.2em;
      text-transform: uppercase;
      color: #9ca3af;
    }

    .prayer-pill .prayer-time {
      font-size: 1.45rem;
      color: #e5e7eb;
      font-variant-numeric: tabular-nums;
    }

    .prayer-pill.active {
      background: radial-gradient(circle at top, #4f46e5, #111827);
      box-shadow: 0 0 22px rgba(129, 140, 248, 0.9);
      transform: translateY(-1px);
    }

    .prayer-pill.upcoming {
      background: rgba(31, 41, 55, 0.98);
      box-shadow: 0 0 16px rgba(55, 65, 81, 0.8);
    }

    @media (max-width: 600px) {
      .wrapper {
        padding: 18px 14px 18px;
        gap: 18px;
      }
      .time { font-size: clamp(5rem, 22vw, 9rem); }
      .status-main { font-size: 1.9rem; }
      .status-main.fajr-large { font-size: clamp(3.5rem, 15vw, 7rem); }
      .status-detail { font-size: 1.3rem; }
      .status-detail.fajr-large { font-size: clamp(2rem, 10vw, 4rem); }
      .prayer-pill { padding: 10px 6px 12px; }
      .prayer-pill .prayer-name { font-size: 0.9rem; }
      .prayer-pill .prayer-time { font-size: 1.1rem; }
    }
  </style>
</head>

<body>
  <div class="wrapper">
    <div class="header-bismillah">
      بِسْمِ ٱللّٰهِ ٱلرَّحْمَٰنِ ٱلرَّحِيمِ
    </div>

    <div class="clock-container">
      <div id="time" class="time">--:--</div>
      <div id="date" class="date"></div>
    </div>

    <div class="status-block">
      <div class="status-label">Salah window · Farmingdale, NY · Hanafi Asr</div>
      <div id="statusMain" class="status-main">Loading prayer times…</div>
      <div id="statusDetail" class="status-detail"></div>
      <div class="small-note">
        Red means you’re in the last minutes of this prayer window.
      </div>
    </div>

    <div class="prayer-row">
      <div class="prayer-pill" data-prayer="Fajr">
        <div class="prayer-name">Fajr</div>
        <div class="prayer-time" id="timeFajr">--:--</div>
      </div>
      <div class="prayer-pill" data-prayer="Dhuhr">
        <div class="prayer-name">Dhuhr</div>
        <div class="prayer-time" id="timeDhuhr">--:--</div>
      </div>
      <div class="prayer-pill" data-prayer="Asr">
        <div class="prayer-name">Asr</div>
        <div class="prayer-time" id="timeAsr">--:--</div>
      </div>
      <div class="prayer-pill" data-prayer="Maghrib">
        <div class="prayer-name">Maghrib</div>
        <div class="prayer-time" id="timeMaghrib">--:--</div>
      </div>
      <div class="prayer-pill" data-prayer="Isha">
        <div class="prayer-name">Isha</div>
        <div class="prayer-time" id="timeIsha">--:--</div>
      </div>
    </div>
  </div>

  <script>
    // CONFIG
    const LATITUDE = 40.7326; // Farmingdale, NY approx
    const LONGITUDE = -73.4454;
    const TIMEZONE = "America/New_York";
    const METHOD = 2; // ISNA
    const SCHOOL = 1; // Hanafi Asr

    // minutes before sunrise to enter "danger" Fajr mode
    const FAJR_WARNING_BEFORE_SUNRISE_MIN = 15;

    // minutes before end for other prayers
    const WARNING_WINDOWS = {
      Fajr: 15,
      Dhuhr: 45,
      Asr: 20,
      Maghrib: 5,
      Isha: 45
    };

    const PRAYER_ORDER = ["Fajr", "Dhuhr", "Asr", "Maghrib", "Isha"];

    let timingsDateKey = null;
    let prayerTimes = null; // {Fajr, Dhuhr, Asr, Maghrib, Isha}
    let sunriseTime = null;

    const prayerTimeEls = {
      Fajr: document.getElementById("timeFajr"),
      Dhuhr: document.getElementById("timeDhuhr"),
      Asr: document.getElementById("timeAsr"),
      Maghrib: document.getElementById("timeMaghrib"),
      Isha: document.getElementById("timeIsha")
    };

    function pad(n) { return n < 10 ? "0" + n : "" + n; }

    function formatTime(date) {
      let h = date.getHours();
      const m = pad(date.getMinutes());
      const ampm = h >= 12 ? "PM" : "AM";
      h = h % 12;
      if (h === 0) h = 12;
      return `${h}:${m} ${ampm}`;
    }

    function formatShortTime(date) {
      return formatTime(date);
    }

    function minutesBetween(later, earlier) {
      return Math.round((later - earlier) / 60000);
    }

    function secondsBetween(later, earlier) {
      return Math.floor((later - earlier) / 1000);
    }

    function formatDurationSeconds(totalSeconds) {
      if (totalSeconds < 0) totalSeconds = 0;
      const h = Math.floor(totalSeconds / 3600);
      const m = Math.floor((totalSeconds % 3600) / 60);
      const s = totalSeconds % 60;
      if (h > 0) return `${h}:${pad(m)}:${pad(s)}`;
      return `${m}:${pad(s)}`;
    }

    function updateClock() {
      const now = new Date();
      const timeEl = document.getElementById("time");
      const dateEl = document.getElementById("date");

      timeEl.textContent = formatTime(now);

      const dateFormatter = new Intl.DateTimeFormat("en-US", {
        weekday: "short",
        month: "short",
        day: "numeric",
        year: "numeric"
      });
      dateEl.textContent = dateFormatter.format(now);

      const todayKey = now.toISOString().slice(0, 10);
      if (timingsDateKey !== todayKey) {
        fetchPrayerTimes();
      }

      updateStatus(now);
    }

    function updatePills(active, upcoming) {
      const pills = document.querySelectorAll(".prayer-pill");
      pills.forEach((pill) => {
        pill.classList.remove("active", "upcoming");
        const name = pill.getAttribute("data-prayer");
        if (name === active) pill.classList.add("active");
        else if (name === upcoming) pill.classList.add("upcoming");
      });
    }

    function updateStatus(now) {
      const statusMain = document.getElementById("statusMain");
      const statusDetail = document.getElementById("statusDetail");
      const wrapper = document.querySelector(".wrapper");

      wrapper.classList.remove("fajr-mode", "fajr-warning");

      if (!prayerTimes || !sunriseTime) {
        statusMain.textContent = "Loading prayer times…";
        statusMain.className = "status-main";
        statusDetail.textContent = "";
        statusDetail.className = "status-detail";
        updatePills(null, null);
        return;
      }

      const Fajr = prayerTimes.Fajr;
      const Dhuhr = prayerTimes.Dhuhr;
      const Asr = prayerTimes.Asr;
      const Maghrib = prayerTimes.Maghrib;
      const Isha = prayerTimes.Isha;

      let active = null;
      let upcoming = null;

      if (now < Fajr) {
        // Before Fajr – Fajr countdown, calm mode
        const secsToFajr = secondsBetween(Fajr, now);
        const minsToFajr = minutesBetween(Fajr, now);

        statusMain.textContent = "Fajr starts in";
        statusMain.className = "status-main fajr-large";
        statusDetail.textContent =
          `${formatDurationSeconds(secsToFajr)} (${minsToFajr} min)`;
        statusDetail.className = "status-detail fajr-large";

        active = null;
        upcoming = "Fajr";
      } else if (now >= Fajr && now < sunriseTime) {
        // Fajr window – main focus
        const secsToSunrise = secondsBetween(sunriseTime, now);
        const minsToSunrise = minutesBetween(sunriseTime, now);

        active = "Fajr";
        upcoming = "Dhuhr";

        if (minsToSunrise <= FAJR_WARNING_BEFORE_SUNRISE_MIN) {
          // Danger window
          wrapper.classList.add("fajr-warning");
          statusMain.textContent = `⚠️ Sunrise in ${minsToSunrise} min ⚠️`;
          statusMain.className = "status-main fajr-large danger";
          statusDetail.textContent = formatDurationSeconds(secsToSunrise);
          statusDetail.className = "status-detail fajr-large danger";
        } else {
          // Normal Fajr window
          wrapper.classList.add("fajr-mode");
          statusMain.textContent = `Sunrise in ${minsToSunrise} min`;
          statusMain.className = "status-main fajr-large active";
          statusDetail.textContent = formatDurationSeconds(secsToSunrise);
          statusDetail.className = "status-detail fajr-large";
        }
      } else if (now >= sunriseTime && now < Dhuhr) {
        // After sunrise, before Dhuhr
        active = null;
        upcoming = "Dhuhr";

        statusMain.textContent = "Fajr time is over";
        statusMain.className = "status-main over";

        const minsToDhuhr = minutesBetween(Dhuhr, now);
        statusDetail.textContent =
          `Next: Dhuhr in ${minsToDhuhr} min`;
        statusDetail.className = "status-detail";
      } else if (now >= Dhuhr && now < Asr) {
        // Dhuhr window
        active = "Dhuhr";
        upcoming = "Asr";

        const secsToEnd = secondsBetween(Asr, now);
        const minsToEnd = minutesBetween(Asr, now);
        const warning = WARNING_WINDOWS.Dhuhr;

        if (minsToEnd <= warning) {
          statusMain.textContent = "Dhuhr is about to end";
          statusMain.className = "status-main danger";
          statusDetail.textContent =
            `Hurry. Ends in ${formatDurationSeconds(secsToEnd)} (${minsToEnd} min).`;
          statusDetail.className = "status-detail danger";
        } else {
          statusMain.textContent = "Dhuhr time is in";
          statusMain.className = "status-main active";
          statusDetail.textContent =
            `Ends in ${formatDurationSeconds(secsToEnd)} (${minsToEnd} min)`;
          statusDetail.className = "status-detail";
        }
      } else if (now >= Asr && now < Maghrib) {
        // Asr window
        active = "Asr";
        upcoming = "Maghrib";

        const secsToEnd = secondsBetween(Maghrib, now);
        const minsToEnd = minutesBetween(Maghrib, now);
        const warning = WARNING_WINDOWS.Asr;

        if (minsToEnd <= warning) {
          statusMain.textContent = "Asr is about to end";
          statusMain.className = "status-main danger";
          statusDetail.textContent =
            `Hurry. Ends in ${formatDurationSeconds(secsToEnd)} (${minsToEnd} min).`;
          statusDetail.className = "status-detail danger";
        } else {
          statusMain.textContent = "Asr time is in";
          statusMain.className = "status-main active";
          statusDetail.textContent =
            `Ends in ${formatDurationSeconds(secsToEnd)} (${minsToEnd} min)`;
          statusDetail.className = "status-detail";
        }
      } else if (now >= Maghrib && now < Isha) {
        // Maghrib window
        active = "Maghrib";
        upcoming = "Isha";

        const secsToEnd = secondsBetween(Isha, now);
        const minsToEnd = minutesBetween(Isha, now);
        const warning = WARNING_WINDOWS.Maghrib;

        if (minsToEnd <= warning) {
          statusMain.textContent = "Maghrib is about to end";
          statusMain.className = "status-main danger";
          statusDetail.textContent =
            `Hurry. Ends in ${formatDurationSeconds(secsToEnd)} (${minsToEnd} min).`;
          statusDetail.className = "status-detail danger";
        } else {
          statusMain.textContent = "Maghrib time is in";
          statusMain.className = "status-main active";
          statusDetail.textContent =
            `Ends in ${formatDurationSeconds(secsToEnd)} (${minsToEnd} min)`;
          statusDetail.className = "status-detail";
        }
      } else {
        // Isha window (from Isha until midnight; after midnight new day fetch kicks in)
        active = "Isha";
        upcoming = "Fajr";

        const todayEnd = new Date(
          now.getFullYear(),
          now.getMonth(),
          now.getDate(),
          23,
          59,
          59
        );
        const secsToEnd = secondsBetween(todayEnd, now);
        const minsToEnd = minutesBetween(todayEnd, now);
        const warning = WARNING_WINDOWS.Isha;

        if (minsToEnd <= warning) {
          statusMain.textContent = "Isha is about to end";
          statusMain.className = "status-main danger";
          statusDetail.textContent =
            `Try not to delay. Day ends in ${formatDurationSeconds(secsToEnd)} (${minsToEnd} min).`;
          statusDetail.className = "status-detail danger";
        } else {
          statusMain.textContent = "Isha time is in";
          statusMain.className = "status-main active";
          statusDetail.textContent =
            `Pray before the night ends.`;
          statusDetail.className = "status-detail";
        }
      }

      updatePills(active, upcoming);
    }

    async function fetchPrayerTimes() {
      try {
        const today = new Date();
        const todayKey = today.toISOString().slice(0, 10);

        const url =
          `https://api.aladhan.com/v1/timings?latitude=${LATITUDE}` +
          `&longitude=${LONGITUDE}` +
          `&method=${METHOD}` +
          `&school=${SCHOOL}` +
          `&timezonestring=${encodeURIComponent(TIMEZONE)}`;

        const resp = await fetch(url);
        const json = await resp.json();

        const timings = json.data.timings;

        function makeDateFromTimeString(tstr) {
          const parts = tstr.split(":").map((x) => parseInt(x, 10));
          const h = parts[0];
          const m = parts[1];
          return new Date(
            today.getFullYear(),
            today.getMonth(),
            today.getDate(),
            h,
            m,
            0
          );
        }

        prayerTimes = {
          Fajr: makeDateFromTimeString(timings.Fajr),
          Dhuhr: makeDateFromTimeString(timings.Dhuhr),
          Asr: makeDateFromTimeString(timings.Asr),
          Maghrib: makeDateFromTimeString(timings.Maghrib),
          Isha: makeDateFromTimeString(timings.Isha)
        };

        sunriseTime = makeDateFromTimeString(timings.Sunrise);

        // fill bottom row times
        PRAYER_ORDER.forEach((name) => {
          const el = prayerTimeEls[name];
          if (el && prayerTimes[name]) {
            el.textContent = formatShortTime(prayerTimes[name]);
          }
        });

        timingsDateKey = todayKey;
      } catch (e) {
        console.error("Error fetching prayer times", e);
        const statusMain = document.getElementById("statusMain");
        const statusDetail = document.getElementById("statusDetail");
        statusMain.textContent = "Error loading prayer times";
        statusMain.className = "status-main over";
        statusDetail.textContent =
          "Check internet or try reloading. The page will retry automatically.";
        statusDetail.className = "status-detail";
      }
    }

    fetchPrayerTimes();
    updateClock();
    setInterval(updateClock, 1000);
  </script>
</body>
</html>
